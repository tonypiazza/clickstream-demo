# ==============================================================================
# Clickstream Pipeline - Local Development Infrastructure
# ==============================================================================
#
# This docker-compose file provides local Kafka, PostgreSQL, and OpenSearch
# for development and testing without Aiven.
#
# Usage:
#   docker-compose up -d      # Start local infrastructure
#   docker-compose down       # Stop services
#   docker-compose down -v    # Stop and remove volumes (reset data)
#
# After starting:
#   cp .env.local.example .env
#   clickstream mage start
#   clickstream replay
#
# ==============================================================================

services:
  # ============================================================================
  # Kafka (Apache Kafka with KRaft - no Zookeeper needed)
  # ============================================================================
  kafka:
    image: apache/kafka:3.9.0
    ports:
      - "9092:9092"
    environment:
      # KRaft settings
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # Listener settings
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # Cluster settings
      CLUSTER_ID: clickstream-local-cluster-01
      # Topic settings
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: ${KAFKA_EVENTS_TOPIC_PARTITIONS:-3}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Performance tuning (dev only - NOT safe for production)
      # Original defaults: flush per message, 8 IO threads, 3 network threads, 100KB buffers
      KAFKA_HEAP_OPTS: "-Xms512m -Xmx1g"
      KAFKA_LOG_FLUSH_INTERVAL_MESSAGES: 10000
      KAFKA_LOG_FLUSH_INTERVAL_MS: 1000
      KAFKA_NUM_IO_THREADS: 4
      KAFKA_NUM_NETWORK_THREADS: 4
      KAFKA_SOCKET_SEND_BUFFER_BYTES: 1048576
      KAFKA_SOCKET_RECEIVE_BUFFER_BYTES: 1048576
      KAFKA_REPLICA_FETCH_MAX_BYTES: 10485760
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================================
  # PostgreSQL
  # ============================================================================
  postgresql:
    image: postgres:17-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: clickstream
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    # Performance tuning for max throughput (dev only - NOT safe for production)
    # Original defaults: synchronous_commit=on, shared_buffers=128MB, work_mem=4MB,
    #   maintenance_work_mem=64MB, wal_level=replica, max_wal_size=1GB,
    #   effective_cache_size=4GB, random_page_cost=4.0
    command:
      - "postgres"
      - "-c"
      - "synchronous_commit=off"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "work_mem=64MB"
      - "-c"
      - "maintenance_work_mem=256MB"
      - "-c"
      - "wal_level=minimal"
      - "-c"
      - "max_wal_size=2GB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "effective_cache_size=4GB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "max_wal_senders=0"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d clickstream"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Valkey (Redis-compatible) - For session state storage
  # ============================================================================
  valkey:
    image: valkey/valkey:8-alpine
    ports:
      - "6379:6379"
    # Performance tuning (dev only - no persistence)
    # Original defaults: unlimited memory, noeviction policy, appendonly no
    command:
      - "valkey-server"
      - "--maxmemory"
      - "512mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--appendonly"
      - "no"
      - "--save"
      - ""
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================================================
  # OpenSearch (optional - requires ~1GB RAM)
  # Start with: docker-compose --profile opensearch-enabled up -d
  # ============================================================================
  opensearch:
    profiles: ["opensearch-enabled"]
    image: opensearchproject/opensearch:2
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=false
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=OpenSearch123!
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -u admin:OpenSearch123! https://localhost:9200/_cluster/health -k || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # ============================================================================
  # OpenSearch Dashboards (optional - requires ~512MB RAM)
  # Access at http://localhost:5601 (admin / OpenSearch123!)
  # ============================================================================
  opensearch-dashboards:
    profiles: ["opensearch-enabled"]
    image: opensearchproject/opensearch-dashboards:2
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=["https://opensearch:9200"]
      - OPENSEARCH_USERNAME=admin
      - OPENSEARCH_PASSWORD=OpenSearch123!
    depends_on:
      opensearch:
        condition: service_healthy
